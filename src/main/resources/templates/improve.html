<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" th:content="#{page.description}">
    <title th:text="#{page.title}">Text Verbesserung - KI-gest√ºtzte deutsche Textoptimierung</title>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js" 
            integrity="sha384-kfJm1UHujU89hXr0VHT0u0t4lqavqaoomP6wix8D9fhzTeFvC9DYyaT36//Qd144" 
            crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <a href="#main-content" class="skip-link" th:text="#{accessibility.skipToMainContent}">Zum Hauptinhalt springen</a>
    
    <!-- Top Choosers -->
    <div class="top-choosers">
        <!-- Theme Chooser -->
        <div class="theme-chooser">
            <button type="button" class="theme-btn" id="light-theme-btn"
                    onclick="switchTheme('light')"
                    th:title="#{theme.title.light}"
                    th:text="#{theme.light}">Hell</button>
            <button type="button" class="theme-btn" id="dark-theme-btn"
                    onclick="switchTheme('dark')"
                    th:title="#{theme.title.dark}"
                    th:text="#{theme.dark}">Dunkel</button>
        </div>
        
        <!-- Language Chooser -->
        <div class="language-chooser">
            <button type="button" class="lang-btn" 
                    th:classappend="${#locale.language == 'de'} ? 'active' : ''" 
                    onclick="switchLanguage('de')"
                    title="Deutsch">DE</button>
            <button type="button" class="lang-btn" 
                    th:classappend="${#locale.language == 'en'} ? 'active' : ''" 
                    onclick="switchLanguage('en')"
                    title="English">EN</button>
        </div>
    </div>


    <div class="container">
        <header class="header" role="banner">
            <h1 th:text="#{header.title}">‚ú® Text Verbesserung</h1>
        </header>
        <main id="main-content" class="content" role="main">
        
        <form th:action="@{/improve}" method="post" role="form" aria-labelledby="form-heading">
            <h2 id="form-heading" class="visually-hidden" th:text="#{accessibility.visuallyHiddenFormHeading}">Textverbesserung</h2>
            <div class="form-group">
                <div class="textarea-header">
                    <label for="inputText" th:text="#{form.inputText.label}">Text (Deutsch):</label>
                    <div class="textarea-buttons">
                        <button type="button" class="textarea-btn clear-btn" onclick="clearTextarea()" th:title="#{form.inputText.clear.title}">
                            <svg viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                <path d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z"/>
                            </svg>
                            <span th:text="#{form.inputText.clear}">L√∂schen</span>
                        </button>
                    </div>
                </div>
                <div class="textarea-container">
                    <textarea 
                        id="inputText" 
                        name="inputText" 
                        th:placeholder="#{form.inputText.placeholder}"
                        th:text="${inputText}"
                        required
                        aria-describedby="inputText-help"
                        aria-invalid="false"></textarea>
                </div>
                <div id="inputText-help" class="visually-hidden" th:text="#{accessibility.visuallyHiddenInputHelp}">Geben Sie den deutschen Text ein, den Sie verbessern m√∂chten</div>
            </div>
            
            <div class="form-group">
                <div class="prompt-header">
                    <div class="model-selection">
                        <span class="model-label" id="model-label" th:text="#{form.modelSelection.label}">KI-Modell:</span>
                        <button type="button" id="current-model-display" class="current-model" onclick="toggleModelSelection()" th:text="${selectedModel}" th:title="#{form.modelSelection.title}" aria-describedby="model-label" aria-expanded="false" aria-haspopup="listbox">gpt-4</button>
                        <select id="selectedModel" name="selectedModel" class="model-select-hidden" style="display: none;" aria-labelledby="model-label">
                            <option th:each="model : ${availableModels}" 
                                    th:value="${model}" 
                                    th:text="${model}"
                                    th:selected="${model == selectedModel}"></option>
                        </select>
                    </div>
                    <button type="button" class="prompt-toggle-btn" onclick="togglePromptVisibility()" th:title="#{form.promptToggle.title}" aria-expanded="false" aria-controls="prompt-container">
                        ‚öôÔ∏è <span id="prompt-toggle-text" th:text="#{form.promptToggle.show}">Prompt anzeigen</span>
                    </button>
                </div>
                <div id="prompt-container" class="prompt-container" style="display: none;" role="region" aria-labelledby="prompt-heading">
                    <label for="customPrompt" id="prompt-heading" class="visually-hidden" th:text="#{accessibility.visuallyHiddenPromptHeading}">Benutzerdefinierter Prompt</label>
                    <textarea 
                        id="customPrompt" 
                        name="customPrompt" 
                        class="prompt-textarea"
                        th:placeholder="#{form.customPrompt.placeholder}"
                        aria-describedby="prompt-help"
                        th:text="${customPrompt}">Prompt</textarea>
                    <div id="prompt-help" class="visually-hidden" th:text="#{accessibility.visuallyHiddenPromptHelp}">Anpassung des KI-Prompts f√ºr die Textverbesserung</div>
                </div>
            </div>
            
            <div class="button-group">
                <button type="submit" class="btn" id="submitBtn" aria-describedby="loading" th:text="#{form.submit.button}">üöÄ Text verbessern</button>
                <button type="button" class="btn btn-secondary" id="externalLlmBtn" onclick="showExternalLlmModal()" th:text="#{form.externalLlm.button}">üìã Externes LLM verwenden</button>
            </div>
            <div class="loading" id="loading" role="status" aria-live="polite" aria-atomic="true" th:text="#{loading.processing}">‚è≥ Text wird verarbeitet...</div>
            
            <div th:if="${error}" class="error" role="alert" aria-live="assertive" th:text="${error}"></div>
        </form>

        <!-- External LLM Modal -->
        <div id="externalLlmModal" class="modal" style="display: none;" role="dialog" aria-labelledby="external-llm-heading" aria-modal="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="external-llm-heading" th:text="#{form.externalLlm.title}">Externes LLM verwenden</h3>
                    <button type="button" class="modal-close" onclick="hideExternalLlmModal()" aria-label="Schlie√üen">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="external-llm-step">
                        <h4 th:text="#{form.externalLlm.step1.title}">Schritt 1: Prompt kopieren</h4>
                        <p th:text="#{form.externalLlm.step1.description}">Kopieren Sie den folgenden Prompt und f√ºgen Sie ihn in Ihr externes LLM ein:</p>
                        <div class="prompt-display-container">
                            <div id="combinedPromptDisplay" class="prompt-display"></div>
                            <button type="button" class="copy-button" onclick="copyPromptToClipboard()" id="copyPromptButton">
                                <svg class="copy-icon" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                                    <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                                    <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                                </svg>
                                <span th:text="#{form.externalLlm.copyPrompt}">Prompt kopieren</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="external-llm-step">
                        <h4 th:text="#{form.externalLlm.step2.title}">Schritt 2: Antwort einf√ºgen</h4>
                        <p th:text="#{form.externalLlm.step2.description}">F√ºgen Sie die Antwort des externen LLMs hier ein:</p>
                        <div class="textarea-container">
                            <textarea id="externalLlmResponse" 
                                     class="external-response-textarea"
                                     th:placeholder="#{form.externalLlm.response.placeholder}"
                                     rows="8"></textarea>
                        </div>
                        <button type="button" class="btn" onclick="processExternalLlmResponse()" id="processResponseBtn" th:text="#{form.externalLlm.process}">Antwort verarbeiten</button>
                    </div>
                </div>
            </div>
        </div>

        <section th:if="${improvedText}" class="result-section" role="region" aria-labelledby="results-heading">
            <div class="result-header">
                <h2 id="results-heading" th:text="#{results.heading}">Verbesserter Text:</h2>
                <button type="button" class="copy-button" onclick="copyToClipboard()" 
                        aria-label="Copy improved text to clipboard" 
                        th:aria-label="#{results.copy.button}"
                        id="copyButton">
                    <svg class="copy-icon" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                        <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                        <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                    </svg>
                    <span th:text="#{results.copy.button}">In Zwischenablage kopieren</span>
                </button>
            </div>
            <div class="result-text" th:text="${improvedText}" role="textbox" aria-readonly="true" tabindex="0" id="resultText"></div>
            
            <div style="margin-top: 30px;">
                <h3 id="diff-heading" th:text="#{results.diff.heading}">üîç Detaillierte √Ñnderungen:</h3>
                <div class="diff-controls" role="tablist" aria-labelledby="diff-heading">
                    <button type="button" class="diff-toggle-btn active" data-mode="side-by-side" onclick="toggleDiffMode('side-by-side')" role="tab" aria-selected="true" aria-controls="diff-container" id="tab-side-by-side" th:text="#{results.diff.sideBySide}">Nebeneinander</button>
                    <button type="button" class="diff-toggle-btn" data-mode="unified" onclick="toggleDiffMode('unified')" role="tab" aria-selected="false" aria-controls="diff-container" id="tab-unified" th:text="#{results.diff.unified}">Vereinheitlicht</button>
                </div>
                <div id="diff-container" class="diff-container" role="tabpanel" aria-labelledby="tab-side-by-side">
                    <!-- Diff will be rendered here by JavaScript -->
                </div>
            </div>
            
            
            <!-- Hidden elements for JavaScript to access the texts -->
            <div id="original-text" style="display: none;" th:text="${inputText}"></div>
            <div id="improved-text" style="display: none;" th:text="${improvedText}"></div>
        </section>
        </main>
    </div>

    <script th:src="@{/js/main.js}"></script>
</body>
</html>