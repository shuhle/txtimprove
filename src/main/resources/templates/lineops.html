<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" th:content="#{lineops.page.description}">
    <title th:text="#{lineops.page.title}">Zeilen-Operationen - KI-gestützte Textbearbeitung</title>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js" 
            integrity="sha384-kfJm1UHujU89hXr0VHT0u0t4lqavqaoomP6wix8D9fhzTeFvC9DYyaT36//Qd144" 
            crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <a href="#main-content" class="skip-link" th:text="#{accessibility.skipToMainContent}">Zum Hauptinhalt springen</a>
    
    <!-- Top Choosers -->
    <div class="top-choosers">
        <!-- Theme Chooser -->
        <div class="theme-chooser">
            <button type="button" class="theme-btn" id="light-theme-btn"
                    onclick="switchTheme('light')"
                    th:title="#{theme.title.light}"
                    th:text="#{theme.light}">Hell</button>
            <button type="button" class="theme-btn" id="dark-theme-btn"
                    onclick="switchTheme('dark')"
                    th:title="#{theme.title.dark}"
                    th:text="#{theme.dark}">Dunkel</button>
        </div>
        
        <!-- Language Chooser -->
        <div class="language-chooser">
            <button type="button" class="lang-btn" 
                    th:classappend="${#locale.language == 'de'} ? 'active' : ''" 
                    onclick="switchLanguage('de')"
                    title="Deutsch">DE</button>
            <button type="button" class="lang-btn" 
                    th:classappend="${#locale.language == 'en'} ? 'active' : ''" 
                    onclick="switchLanguage('en')"
                    title="English">EN</button>
        </div>
    </div>

    <!-- Back Button -->
    <div class="back-button-container">
        <a href="/" class="back-button" th:title="#{navigation.back.title}">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
            </svg>
            <span th:text="#{navigation.back}">Zurück</span>
        </a>
    </div>

    <div class="container">
        <header class="header" role="banner">
            <h1 th:text="#{lineops.header.title}">📋 Zeilen-Operationen</h1>
            <p class="subtitle" th:text="#{lineops.header.subtitle}">KI-gestützte Bearbeitung jeder Zeile</p>
        </header>
        <main id="main-content" class="content" role="main">
        
        <form th:action="@{/lineops}" method="post" onsubmit="showLoading()" role="form" aria-labelledby="form-heading">
            <h2 id="form-heading" class="visually-hidden" th:text="#{accessibility.visuallyHiddenFormHeading}">Zeilen-Operationen</h2>
            
            <div class="form-group">
                <label for="lineInstruction" th:text="#{lineops.form.lineInstruction.label}">Anweisung pro Zeile:</label>
                <textarea 
                    id="lineInstruction" 
                    name="lineInstruction" 
                    th:placeholder="#{lineops.form.lineInstruction.placeholder}"
                    th:text="${lineInstruction}"
                    required
                    rows="2"
                    aria-describedby="lineInstruction-help"
                    aria-invalid="false"></textarea>
                <div id="lineInstruction-help" class="visually-hidden" th:text="#{accessibility.visuallyHiddenLineInstructionHelp}">Geben Sie die Anweisung ein, die auf jede Zeile angewendet werden soll</div>
            </div>
            
            <div class="form-group">
                <label for="fileContent" th:text="#{lineops.form.fileContent.label}">Dateiinhalt:</label>
                <textarea 
                    id="fileContent" 
                    name="fileContent" 
                    th:placeholder="#{lineops.form.fileContent.placeholder}"
                    th:text="${fileContent}"
                    required
                    rows="12"
                    aria-describedby="fileContent-help"
                    aria-invalid="false"></textarea>
                <div id="fileContent-help" class="visually-hidden" th:text="#{accessibility.visuallyHiddenFileContentHelp}">Fügen Sie den Inhalt der Datei ein, auf die die Operation angewendet werden soll</div>
            </div>
            
            <div class="form-group">
                <div class="prompt-header">
                    <div class="model-selection">
                        <span class="model-label" id="model-label" th:text="#{form.modelSelection.label}">KI-Modell:</span>
                        <button type="button" id="current-model-display" class="current-model" onclick="toggleModelSelection()" th:text="${selectedModel}" th:title="#{form.modelSelection.title}" aria-describedby="model-label" aria-expanded="false" aria-haspopup="listbox">gpt-4</button>
                        <select id="selectedModel" name="selectedModel" class="model-select-hidden" style="display: none;" aria-labelledby="model-label">
                            <option th:each="model : ${availableModels}" 
                                    th:value="${model}" 
                                    th:text="${model}"
                                    th:selected="${model == selectedModel}"></option>
                        </select>
                    </div>
                    <button type="button" class="prompt-toggle-btn" onclick="togglePromptVisibility()" th:title="#{form.promptToggle.title}" aria-expanded="false" aria-controls="prompt-container">
                        ⚙️ <span id="prompt-toggle-text" th:text="#{form.promptToggle.show}">Prompt anzeigen</span>
                    </button>
                </div>
                <div id="prompt-container" class="prompt-container" style="display: none;" role="region" aria-labelledby="prompt-heading">
                    <label for="customPrompt" id="prompt-heading" class="visually-hidden" th:text="#{accessibility.visuallyHiddenPromptHeading}">Benutzerdefinierter Prompt</label>
                    <textarea 
                        id="customPrompt" 
                        name="customPrompt" 
                        class="prompt-textarea"
                        th:placeholder="#{lineops.form.customPrompt.placeholder}"
                        aria-describedby="prompt-help"
                        th:text="${customPrompt}">Du bist ein Textverarbeitungsassistent. Du erhältst Dateiinhalt und eine Anweisung für jede Zeile.

WICHTIG: Gib ausschließlich den verarbeiteten Text aus - ohne Erklärungen, Kommentare, Emojis, Markdown oder sonstige Zusätze.

Dateiinhalt (jede Zeile einzeln verarbeiten):
{file_content}

Anweisung für jede Zeile:
{line_instruction}

Wende die Anweisung auf jede Zeile einzeln an und gib das Ergebnis aus (nur der verarbeitete Text, keine Erklärungen):</textarea>
                    <div id="prompt-help" class="visually-hidden" th:text="#{accessibility.visuallyHiddenPromptHelp}">Anpassung des KI-Prompts für die Zeilen-Operationen</div>
                </div>
            </div>
            
            <button type="submit" class="btn" id="submitBtn" aria-describedby="loading" th:text="#{lineops.form.submit.button}">🚀 Operationen ausführen</button>
            <div class="loading" id="loading" role="status" aria-live="polite" aria-atomic="true" th:text="#{loading.processing}">⏳ Text wird verarbeitet...</div>
            
            <div th:if="${error}" class="error" role="alert" aria-live="assertive" th:text="${error}"></div>
        </form>

        <section th:if="${processedText}" class="result-section" role="region" aria-labelledby="results-heading">
            <div class="result-header">
                <h2 id="results-heading" th:text="#{lineops.results.heading}">Verarbeiteter Text:</h2>
                <button type="button" class="copy-button" onclick="copyToClipboard()" 
                        aria-label="Copy processed text to clipboard" 
                        th:aria-label="#{results.copy.button}"
                        id="copyButton">
                    <svg class="copy-icon" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                        <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                        <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                    </svg>
                    <span th:text="#{results.copy.button}">In Zwischenablage kopieren</span>
                </button>
            </div>
            <div class="result-text" th:text="${processedText}" role="textbox" aria-readonly="true" tabindex="0" id="resultText"></div>
            
            <div style="margin-top: 30px;">
                <h3 id="diff-heading" th:text="#{results.diff.heading}">🔍 Detaillierte Änderungen:</h3>
                <div class="diff-controls" role="tablist" aria-labelledby="diff-heading">
                    <button type="button" class="diff-toggle-btn active" data-mode="side-by-side" onclick="toggleDiffMode('side-by-side')" role="tab" aria-selected="true" aria-controls="diff-container" id="tab-side-by-side" th:text="#{results.diff.sideBySide}">Nebeneinander</button>
                    <button type="button" class="diff-toggle-btn" data-mode="unified" onclick="toggleDiffMode('unified')" role="tab" aria-selected="false" aria-controls="diff-container" id="tab-unified" th:text="#{results.diff.unified}">Vereinheitlicht</button>
                </div>
                <div id="diff-container" class="diff-container" role="tabpanel" aria-labelledby="tab-side-by-side">
                    <!-- Diff will be rendered here by JavaScript -->
                </div>
            </div>
            
            
            <!-- Hidden elements for JavaScript to access the texts -->
            <div id="original-text" style="display: none;" th:text="${fileContent}"></div>
            <div id="improved-text" style="display: none;" th:text="${processedText}"></div>
        </section>
        </main>
    </div>

    <script th:inline="javascript">
        // Internationalized messages for JavaScript
        var messages = {
            'form.submit.processing': /*[[#{form.submit.processing}]]*/ '⏳ Verarbeitung läuft...',
            'loading.processingWait': /*[[#{loading.processingWait}]]*/ 'Text wird verarbeitet. Bitte warten...',
            'error.emptyText': /*[[#{error.emptyText}]]*/ 'Bitte geben Sie einen Text ein, der verbessert werden soll.',
            'error.minLength': /*[[#{error.minLength}]]*/ 'Der Text muss mindestens 3 Zeichen lang sein.',
            'error.maxLength': /*[[#{error.maxLength}]]*/ 'Der Text darf maximal 10.000 Zeichen lang sein.',
            'error.diffLibraryNotLoaded': /*[[#{error.diffLibraryNotLoaded}]]*/ 'Diff library not loaded. Please refresh the page.',
            'form.promptToggle.hide': /*[[#{form.promptToggle.hide}]]*/ 'Prompt ausblenden',
            'form.promptToggle.show': /*[[#{form.promptToggle.show}]]*/ 'Prompt anzeigen',
            'results.diff.originalText': /*[[#{results.diff.originalText}]]*/ 'Originaltext',
            'results.diff.improvedText': /*[[#{results.diff.improvedText}]]*/ 'Verbesserter Text',
            'results.copy.button': /*[[#{results.copy.button}]]*/ 'In Zwischenablage kopieren',
            'results.copy.success': /*[[#{results.copy.success}]]*/ 'Text kopiert!',
            'results.copy.error': /*[[#{results.copy.error}]]*/ 'Kopieren fehlgeschlagen',
            'announce.promptOpened': /*[[#{announce.promptOpened}]]*/ 'Prompt-Bereich geöffnet',
            'announce.promptClosed': /*[[#{announce.promptClosed}]]*/ 'Prompt-Bereich geschlossen',
            'announce.modelSelectionOpened': /*[[#{announce.modelSelectionOpened}]]*/ 'Modellauswahl geöffnet',
            'announce.modelSelected': /*[[#{announce.modelSelected}]]*/ 'Modell gewählt: {0}',
            'announce.diffModeChanged.sideBySide': /*[[#{announce.diffModeChanged.sideBySide}]]*/ 'Ansicht gewechselt zu Nebeneinander',
            'announce.diffModeChanged.unified': /*[[#{announce.diffModeChanged.unified}]]*/ 'Ansicht gewechselt zu Vereinheitlicht',
            'announce.textImprovementCompleted': /*[[#{announce.textImprovementCompleted}]]*/ 'Textverbesserung abgeschlossen. Ergebnisse verfügbar.',
            'announce.error': /*[[#{announce.error}]]*/ 'Fehler: {0}'
        };
    </script>
    <script th:src="@{/js/main.js}"></script>
</body>
</html>