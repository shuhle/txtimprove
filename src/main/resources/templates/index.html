<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" th:content="#{page.description}">
    <title th:text="#{page.title}">Text Verbesserung - KI-gest√ºtzte deutsche Textoptimierung</title>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js" 
            integrity="sha384-kfJm1UHujU89hXr0VHT0u0t4lqavqaoomP6wix8D9fhzTeFvC9DYyaT36//Qd144" 
            crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <a href="#main-content" class="skip-link" th:text="#{accessibility.skipToMainContent}">Zum Hauptinhalt springen</a>
    
    <!-- Top Choosers -->
    <div class="top-choosers">
        <!-- Theme Chooser -->
        <div class="theme-chooser">
            <button type="button" class="theme-btn" id="light-theme-btn"
                    onclick="switchTheme('light')"
                    th:title="#{theme.title.light}"
                    th:text="#{theme.light}">Hell</button>
            <button type="button" class="theme-btn" id="dark-theme-btn"
                    onclick="switchTheme('dark')"
                    th:title="#{theme.title.dark}"
                    th:text="#{theme.dark}">Dunkel</button>
        </div>
        
        <!-- Language Chooser -->
        <div class="language-chooser">
            <button type="button" class="lang-btn" 
                    th:classappend="${#locale.language == 'de'} ? 'active' : ''" 
                    onclick="switchLanguage('de')"
                    title="Deutsch">DE</button>
            <button type="button" class="lang-btn" 
                    th:classappend="${#locale.language == 'en'} ? 'active' : ''" 
                    onclick="switchLanguage('en')"
                    title="English">EN</button>
        </div>
    </div>

    <div class="container">
        <header class="header" role="banner">
            <h1 th:text="#{header.title}">‚ú® Text Verbesserung</h1>
            <p class="subtitle" th:text="#{header.subtitle}">f√ºr deutsche Texte mit KI-Unterst√ºtzung</p>
        </header>
        <main id="main-content" class="content" role="main">
        
        <form th:action="@{/improve}" method="post" onsubmit="showLoading()" role="form" aria-labelledby="form-heading">
            <h2 id="form-heading" class="visually-hidden" th:text="#{accessibility.visuallyHiddenFormHeading}">Textverbesserung</h2>
            <div class="form-group">
                <label for="inputText" th:text="#{form.inputText.label}">Text (Deutsch):</label>
                <textarea 
                    id="inputText" 
                    name="inputText" 
                    th:placeholder="#{form.inputText.placeholder}"
                    th:text="${inputText}"
                    required
                    aria-describedby="inputText-help"
                    aria-invalid="false"></textarea>
                <div id="inputText-help" class="visually-hidden" th:text="#{accessibility.visuallyHiddenInputHelp}">Geben Sie den deutschen Text ein, den Sie verbessern m√∂chten</div>
            </div>
            
            <div class="form-group">
                <div class="prompt-header">
                    <div class="model-selection">
                        <span class="model-label" id="model-label" th:text="#{form.modelSelection.label}">KI-Modell:</span>
                        <button type="button" id="current-model-display" class="current-model" onclick="toggleModelSelection()" th:text="${selectedModel}" th:title="#{form.modelSelection.title}" aria-describedby="model-label" aria-expanded="false" aria-haspopup="listbox">gpt-4</button>
                        <select id="selectedModel" name="selectedModel" class="model-select-hidden" style="display: none;" aria-labelledby="model-label">
                            <option th:each="model : ${availableModels}" 
                                    th:value="${model}" 
                                    th:text="${model}"
                                    th:selected="${model == selectedModel}"></option>
                        </select>
                    </div>
                    <button type="button" class="prompt-toggle-btn" onclick="togglePromptVisibility()" th:title="#{form.promptToggle.title}" aria-expanded="false" aria-controls="prompt-container">
                        ‚öôÔ∏è <span id="prompt-toggle-text" th:text="#{form.promptToggle.show}">Prompt anzeigen</span>
                    </button>
                </div>
                <div id="prompt-container" class="prompt-container" style="display: none;" role="region" aria-labelledby="prompt-heading">
                    <label for="customPrompt" id="prompt-heading" class="visually-hidden" th:text="#{accessibility.visuallyHiddenPromptHeading}">Benutzerdefinierter Prompt</label>
                    <textarea 
                        id="customPrompt" 
                        name="customPrompt" 
                        class="prompt-textarea"
                        th:placeholder="#{form.customPrompt.placeholder}"
                        aria-describedby="prompt-help"
                        th:text="${customPrompt}">Du bist ein professioneller Texteditor und Schreibcoach f√ºr die deutsche Sprache. 

WICHTIG: Gib ausschlie√ülich den verbesserten Text aus - ohne Erkl√§rungen, Kommentare, Emojis, Markdown oder sonstige Zus√§tze.

Verbessere den folgenden deutschen Text, indem du:
1. Grammatik und Rechtschreibung korrigierst
2. Den Stil und die Lesbarkeit verbesserst
3. Klarheit und Pr√§zision erh√∂hst
4. Den Ton professioneller und ansprechender machst
5. Die Struktur optimierst

Behalte dabei den urspr√ºnglichen Sinn und die Intention des Textes bei.
Behalte die urspr√ºngliche Struktur und Formatierung (Abs√§tze, Listen) bei.

Urspr√ºnglicher Text:
{input_text}

Verbesserter Text (nur der Text, keine Erkl√§rungen):</textarea>
                    <div id="prompt-help" class="visually-hidden" th:text="#{accessibility.visuallyHiddenPromptHelp}">Anpassung des KI-Prompts f√ºr die Textverbesserung</div>
                </div>
            </div>
            
            <button type="submit" class="btn" id="submitBtn" aria-describedby="loading" th:text="#{form.submit.button}">üöÄ Text verbessern</button>
            <div class="loading" id="loading" role="status" aria-live="polite" aria-atomic="true" th:text="#{loading.processing}">‚è≥ Text wird verarbeitet...</div>
            
            <div th:if="${error}" class="error" role="alert" aria-live="assertive" th:text="${error}"></div>
        </form>

        <section th:if="${improvedText}" class="result-section" role="region" aria-labelledby="results-heading">
            <div class="result-header">
                <h2 id="results-heading" th:text="#{results.heading}">Verbesserter Text:</h2>
                <button type="button" class="copy-button" onclick="copyToClipboard()" 
                        aria-label="Copy improved text to clipboard" 
                        th:aria-label="#{results.copy.button}"
                        id="copyButton">
                    <svg class="copy-icon" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                        <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/>
                        <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/>
                    </svg>
                    <span th:text="#{results.copy.button}">In Zwischenablage kopieren</span>
                </button>
            </div>
            <div class="result-text" th:text="${improvedText}" role="textbox" aria-readonly="true" tabindex="0" id="resultText"></div>
            
            <div style="margin-top: 30px;">
                <h3 id="diff-heading" th:text="#{results.diff.heading}">üîç Detaillierte √Ñnderungen:</h3>
                <div class="diff-controls" role="tablist" aria-labelledby="diff-heading">
                    <button type="button" class="diff-toggle-btn active" data-mode="side-by-side" onclick="toggleDiffMode('side-by-side')" role="tab" aria-selected="true" aria-controls="diff-container" id="tab-side-by-side" th:text="#{results.diff.sideBySide}">Nebeneinander</button>
                    <button type="button" class="diff-toggle-btn" data-mode="unified" onclick="toggleDiffMode('unified')" role="tab" aria-selected="false" aria-controls="diff-container" id="tab-unified" th:text="#{results.diff.unified}">Vereinheitlicht</button>
                </div>
                <div id="diff-container" class="diff-container" role="tabpanel" aria-labelledby="tab-side-by-side">
                    <!-- Diff will be rendered here by JavaScript -->
                </div>
            </div>
            
            
            <!-- Hidden elements for JavaScript to access the texts -->
            <div id="original-text" style="display: none;" th:text="${inputText}"></div>
            <div id="improved-text" style="display: none;" th:text="${improvedText}"></div>
        </section>
        </main>
    </div>

    <script th:inline="javascript">
        // Internationalized messages for JavaScript
        var messages = {
            'form.submit.processing': /*[[#{form.submit.processing}]]*/ '‚è≥ Verarbeitung l√§uft...',
            'loading.processingWait': /*[[#{loading.processingWait}]]*/ 'Text wird verarbeitet. Bitte warten...',
            'error.emptyText': /*[[#{error.emptyText}]]*/ 'Bitte geben Sie einen Text ein, der verbessert werden soll.',
            'error.minLength': /*[[#{error.minLength}]]*/ 'Der Text muss mindestens 3 Zeichen lang sein.',
            'error.maxLength': /*[[#{error.maxLength}]]*/ 'Der Text darf maximal 10.000 Zeichen lang sein.',
            'error.diffLibraryNotLoaded': /*[[#{error.diffLibraryNotLoaded}]]*/ 'Diff library not loaded. Please refresh the page.',
            'form.promptToggle.hide': /*[[#{form.promptToggle.hide}]]*/ 'Prompt ausblenden',
            'form.promptToggle.show': /*[[#{form.promptToggle.show}]]*/ 'Prompt anzeigen',
            'results.diff.originalText': /*[[#{results.diff.originalText}]]*/ 'Originaltext',
            'results.diff.improvedText': /*[[#{results.diff.improvedText}]]*/ 'Verbesserter Text',
            'results.copy.button': /*[[#{results.copy.button}]]*/ 'In Zwischenablage kopieren',
            'results.copy.success': /*[[#{results.copy.success}]]*/ 'Text kopiert!',
            'results.copy.error': /*[[#{results.copy.error}]]*/ 'Kopieren fehlgeschlagen',
            'announce.promptOpened': /*[[#{announce.promptOpened}]]*/ 'Prompt-Bereich ge√∂ffnet',
            'announce.promptClosed': /*[[#{announce.promptClosed}]]*/ 'Prompt-Bereich geschlossen',
            'announce.modelSelectionOpened': /*[[#{announce.modelSelectionOpened}]]*/ 'Modellauswahl ge√∂ffnet',
            'announce.modelSelected': /*[[#{announce.modelSelected}]]*/ 'Modell gew√§hlt: {0}',
            'announce.diffModeChanged.sideBySide': /*[[#{announce.diffModeChanged.sideBySide}]]*/ 'Ansicht gewechselt zu Nebeneinander',
            'announce.diffModeChanged.unified': /*[[#{announce.diffModeChanged.unified}]]*/ 'Ansicht gewechselt zu Vereinheitlicht',
            'announce.textImprovementCompleted': /*[[#{announce.textImprovementCompleted}]]*/ 'Textverbesserung abgeschlossen. Ergebnisse verf√ºgbar.',
            'announce.error': /*[[#{announce.error}]]*/ 'Fehler: {0}'
        };

        function getMessage(key, ...args) {
            let message = messages[key] || key;
            if (args.length > 0) {
                args.forEach((arg, index) => {
                    message = message.replace('{' + index + '}', arg);
                });
            }
            return message;
        }

        function switchLanguage(lang) {
            const url = new URL(window.location);
            url.searchParams.set('lang', lang);
            window.location.href = url.toString();
        }

        function switchTheme(theme) {
            // Validate theme parameter
            if (theme !== 'light' && theme !== 'dark') {
                console.warn('Invalid theme:', theme);
                return;
            }
            
            const html = document.documentElement;
            const lightBtn = document.getElementById('light-theme-btn');
            const darkBtn = document.getElementById('dark-theme-btn');
            
            // Update data-theme attribute
            html.setAttribute('data-theme', theme);
            
            // Update button states
            lightBtn.classList.remove('active');
            darkBtn.classList.remove('active');
            
            if (theme === 'light') {
                lightBtn.classList.add('active');
            } else {
                darkBtn.classList.add('active');
            }
            
            // Store preference in localStorage (validated theme)
            try {
                localStorage.setItem('theme', theme);
            } catch (e) {
                console.warn('Could not save theme preference:', e);
            }
        }

        function initializeTheme() {
            const html = document.documentElement;
            const lightBtn = document.getElementById('light-theme-btn');
            const darkBtn = document.getElementById('dark-theme-btn');
            
            // Check for stored preference with validation
            const storedTheme = localStorage.getItem('theme');
            
            if (storedTheme && (storedTheme === 'light' || storedTheme === 'dark')) {
                // Use stored preference only if it's valid
                switchTheme(storedTheme);
            } else {
                // Check system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    darkBtn.classList.add('active');
                } else {
                    lightBtn.classList.add('active');
                }
            }
            
            // Listen for system theme changes when no manual preference is set
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    lightBtn.classList.remove('active');
                    darkBtn.classList.remove('active');
                    if (e.matches) {
                        darkBtn.classList.add('active');
                    } else {
                        lightBtn.classList.add('active');
                    }
                }
            });
        }

        function showLoading() {
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const inputText = document.getElementById('inputText');
            
            // Validate form before submission
            if (!validateForm()) {
                return false;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = getMessage('form.submit.processing');
            submitBtn.setAttribute('aria-busy', 'true');
            loading.style.display = 'block';
            loading.textContent = getMessage('loading.processingWait');
            
            // Remove any existing error states
            clearFormErrors();
            
            return true;
        }
        
        function validateForm() {
            const inputText = document.getElementById('inputText');
            const textValue = inputText.value.trim();
            
            // Clear previous errors
            clearFormErrors();
            
            // Check if text is empty
            if (!textValue) {
                showFieldError(inputText, getMessage('error.emptyText'));
                return false;
            }
            
            // Check minimum length (at least 3 characters)
            if (textValue.length < 3) {
                showFieldError(inputText, getMessage('error.minLength'));
                return false;
            }
            
            // Check maximum length (reasonable limit)
            if (textValue.length > 10000) {
                showFieldError(inputText, getMessage('error.maxLength'));
                return false;
            }
            
            return true;
        }
        
        function showFieldError(field, message) {
            // Create or update error message
            let errorElement = document.getElementById(field.id + '-error');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = field.id + '-error';
                errorElement.className = 'field-error';
                errorElement.setAttribute('role', 'alert');
                errorElement.setAttribute('aria-live', 'polite');
                field.parentNode.appendChild(errorElement);
            }
            
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Update field ARIA attributes
            field.setAttribute('aria-invalid', 'true');
            field.setAttribute('aria-describedby', field.getAttribute('aria-describedby') + ' ' + errorElement.id);
            
            // Focus the field
            field.focus();
            
            // Announce error to screen readers
            announceToScreenReader(getMessage('announce.error', message));
        }
        
        function clearFormErrors() {
            const errorElements = document.querySelectorAll('.field-error');
            errorElements.forEach(error => {
                error.style.display = 'none';
            });
            
            // Reset ARIA attributes
            const inputText = document.getElementById('inputText');
            inputText.setAttribute('aria-invalid', 'false');
            inputText.setAttribute('aria-describedby', 'inputText-help');
        }

        let currentDiffMode = 'side-by-side';

        function toggleDiffMode(mode) {
            currentDiffMode = mode;
            
            // Update button states and ARIA attributes
            document.querySelectorAll('.diff-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            const activeBtn = document.querySelector(`[data-mode="${mode}"]`);
            activeBtn.classList.add('active');
            activeBtn.setAttribute('aria-selected', 'true');
            
            // Update tabpanel labeling
            const diffContainer = document.getElementById('diff-container');
            diffContainer.setAttribute('aria-labelledby', `tab-${mode}`);
            
            // Announce change to screen readers
            announceToScreenReader(mode === 'side-by-side' ? getMessage('announce.diffModeChanged.sideBySide') : getMessage('announce.diffModeChanged.unified'));
            
            // Re-render diff
            renderDiff();
        }

        function renderDiff() {
            const originalText = document.getElementById('original-text')?.textContent || '';
            const improvedText = document.getElementById('improved-text')?.textContent || '';
            const container = document.getElementById('diff-container');
            
            if (!originalText || !improvedText || !container) return;
            
            if (typeof Diff === 'undefined') {
                // Safe DOM creation instead of innerHTML
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'padding: 15px; color: red;';
                errorDiv.textContent = getMessage('error.diffLibraryNotLoaded');
                container.innerHTML = ''; // Clear first
                container.appendChild(errorDiv);
                return;
            }
            
            // Use word-level diff for better readability
            const diff = Diff.diffWords(originalText, improvedText);
            
            if (currentDiffMode === 'unified') {
                renderUnifiedDiff(diff, container);
            } else {
                renderSideBySideDiff(originalText, improvedText, diff, container);
            }
        }

        function renderUnifiedDiff(diff, container) {
            container.className = 'diff-container';
            const unifiedDiv = document.createElement('div');
            unifiedDiv.className = 'diff-unified';
            
            diff.forEach(function(part) {
                const span = document.createElement('span');
                const className = part.added ? 'diff-added' : 
                                part.removed ? 'diff-removed' : 'diff-unchanged';
                span.className = className;
                span.textContent = part.value; // Safe - uses textContent instead of innerHTML
                unifiedDiv.appendChild(span);
            });
            
            container.innerHTML = ''; // Clear container
            container.appendChild(unifiedDiv);
        }

        function renderSideBySideDiff(originalText, improvedText, diff, container) {
            container.className = 'diff-container';
            
            // Create DOM structure safely
            const sideBySideDiv = document.createElement('div');
            sideBySideDiv.className = 'diff-side-by-side';
            
            // Original column
            const originalColumn = document.createElement('div');
            const originalHeader = document.createElement('div');
            originalHeader.className = 'diff-column-header';
            originalHeader.textContent = getMessage('results.diff.originalText');
            const originalContent = document.createElement('div');
            originalContent.className = 'diff-column';
            originalColumn.appendChild(originalHeader);
            originalColumn.appendChild(originalContent);
            
            // Improved column
            const improvedColumn = document.createElement('div');
            const improvedHeader = document.createElement('div');
            improvedHeader.className = 'diff-column-header';
            improvedHeader.textContent = getMessage('results.diff.improvedText');
            const improvedContent = document.createElement('div');
            improvedContent.className = 'diff-column';
            improvedColumn.appendChild(improvedHeader);
            improvedColumn.appendChild(improvedContent);
            
            // Process diff parts safely
            diff.forEach(function(part) {
                if (part.added) {
                    const span = document.createElement('span');
                    span.className = 'diff-added';
                    span.textContent = part.value;
                    improvedContent.appendChild(span);
                } else if (part.removed) {
                    const span = document.createElement('span');
                    span.className = 'diff-removed';
                    span.textContent = part.value;
                    originalContent.appendChild(span);
                } else {
                    // Unchanged text goes to both columns
                    const originalSpan = document.createElement('span');
                    originalSpan.className = 'diff-unchanged';
                    originalSpan.textContent = part.value;
                    originalContent.appendChild(originalSpan);
                    
                    const improvedSpan = document.createElement('span');
                    improvedSpan.className = 'diff-unchanged';
                    improvedSpan.textContent = part.value;
                    improvedContent.appendChild(improvedSpan);
                }
            });
            
            sideBySideDiv.appendChild(originalColumn);
            sideBySideDiv.appendChild(improvedColumn);
            
            container.innerHTML = ''; // Clear container
            container.appendChild(sideBySideDiv);
        }


        function togglePromptVisibility() {
            const container = document.getElementById('prompt-container');
            const toggleText = document.getElementById('prompt-toggle-text');
            const toggleBtn = document.querySelector('.prompt-toggle-btn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleText.textContent = getMessage('form.promptToggle.hide');
                toggleBtn.setAttribute('aria-expanded', 'true');
                announceToScreenReader(getMessage('announce.promptOpened'));
                document.getElementById('customPrompt').focus();
            } else {
                container.style.display = 'none';
                toggleText.textContent = getMessage('form.promptToggle.show');
                toggleBtn.setAttribute('aria-expanded', 'false');
                announceToScreenReader(getMessage('announce.promptClosed'));
                toggleBtn.focus();
            }
        }

        function toggleModelSelection() {
            const modelSelect = document.getElementById('selectedModel');
            const currentModelDisplay = document.getElementById('current-model-display');
            
            if (modelSelect.style.display === 'none') {
                modelSelect.style.display = 'inline-block';
                currentModelDisplay.style.display = 'none';
                currentModelDisplay.setAttribute('aria-expanded', 'true');
                modelSelect.focus();
                announceToScreenReader(getMessage('announce.modelSelectionOpened'));
            } else {
                modelSelect.style.display = 'none';
                currentModelDisplay.style.display = 'inline';
                currentModelDisplay.setAttribute('aria-expanded', 'false');
                currentModelDisplay.textContent = modelSelect.options[modelSelect.selectedIndex].text;
                currentModelDisplay.focus();
                announceToScreenReader(getMessage('announce.modelSelected', modelSelect.options[modelSelect.selectedIndex].text));
            }
        }

        // Utility function for screen reader announcements
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'visually-hidden';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            // Remove after announcement
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }
        
        // Keyboard navigation support
        document.addEventListener('keydown', function(e) {
            // Tab navigation for diff mode buttons
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const activeElement = document.activeElement;
                if (activeElement.classList.contains('diff-toggle-btn')) {
                    e.preventDefault();
                    const buttons = Array.from(document.querySelectorAll('.diff-toggle-btn'));
                    const currentIndex = buttons.indexOf(activeElement);
                    const nextIndex = e.key === 'ArrowRight' ? 
                        (currentIndex + 1) % buttons.length :
                        (currentIndex - 1 + buttons.length) % buttons.length;
                    buttons[nextIndex].focus();
                    buttons[nextIndex].click();
                }
            }
            
            // Escape key to close dropdowns
            if (e.key === 'Escape') {
                const modelSelect = document.getElementById('selectedModel');
                const promptContainer = document.getElementById('prompt-container');
                
                if (modelSelect.style.display !== 'none') {
                    toggleModelSelection();
                }
                if (promptContainer.style.display !== 'none') {
                    togglePromptVisibility();
                }
            }
            
            // Enter/Space to activate buttons
            if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('current-model')) {
                e.preventDefault();
                toggleModelSelection();
            }
        });
        
        // Form submission handling
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (!validateForm()) {
                        e.preventDefault();
                        return false;
                    }
                    return showLoading();
                });
                
                // Real-time validation feedback
                const inputText = document.getElementById('inputText');
                inputText.addEventListener('input', function() {
                    if (this.getAttribute('aria-invalid') === 'true') {
                        // Clear error if user starts typing
                        clearFormErrors();
                    }
                });
            }
            
            // Initialize diff when page loads and results are available
            if (document.getElementById('original-text') && document.getElementById('improved-text')) {
                renderDiff();
                announceToScreenReader(getMessage('announce.textImprovementCompleted'));
            }
            
            // Add keyboard support for copy button
            const copyButton = document.getElementById('copyButton');
            if (copyButton) {
                copyButton.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        copyToClipboard();
                    }
                });
            }
        });

        // Copy to clipboard functionality
        function copyToClipboard() {
            const resultText = document.getElementById('resultText');
            const copyButton = document.getElementById('copyButton');
            const buttonText = copyButton.querySelector('span');
            
            if (!resultText || !copyButton) {
                console.warn('Copy elements not found');
                return;
            }
            
            // Get the text content
            const textToCopy = resultText.textContent || resultText.innerText;
            
            // Modern clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess(copyButton, buttonText);
                }).catch((err) => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyText(textToCopy, copyButton, buttonText);
                });
            } else {
                // Fallback for older browsers or non-secure contexts
                fallbackCopyText(textToCopy, copyButton, buttonText);
            }
        }
        
        function showCopySuccess(button, buttonText) {
            const originalText = buttonText.textContent;
            
            // Update button appearance
            button.classList.add('success');
            buttonText.textContent = getMessage('results.copy.success');
            
            // Announce to screen readers
            announceToScreenReader(getMessage('results.copy.success'));
            
            // Reset after 2 seconds
            setTimeout(() => {
                button.classList.remove('success');
                buttonText.textContent = originalText;
            }, 2000);
        }
        
        function showCopyError(button, buttonText) {
            const originalText = buttonText.textContent;
            
            // Update button appearance
            button.classList.add('error');
            buttonText.textContent = getMessage('results.copy.error');
            
            // Announce to screen readers
            announceToScreenReader(getMessage('results.copy.error'));
            
            // Reset after 2 seconds
            setTimeout(() => {
                button.classList.remove('error');
                buttonText.textContent = originalText;
            }, 2000);
        }
        
        function fallbackCopyText(text, button, buttonText) {
            // Create a temporary textarea
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            textarea.style.left = '-9999px';
            
            document.body.appendChild(textarea);
            
            try {
                textarea.select();
                textarea.setSelectionRange(0, 99999); // For mobile devices
                
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(button, buttonText);
                } else {
                    showCopyError(button, buttonText);
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showCopyError(button, buttonText);
            } finally {
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>